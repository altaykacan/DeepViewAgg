data.multimodal.settings:
    mapping_key: mapping_index  # hardcoded key used to sync 3D points and modality mappings
    ref_size: [256, 128]  # [512, 256]
    proj_upscale: 4
    r_max: 8
    r_min: 0.05
    growth_k: 0.5
    growth_r: 100  # growth_k and growth_r set so that correction factor is ~1.1 at r_max=8
    per_sphere_memory_credit: 256*256*8
data:
    task: segmentation.multimodal
    class: s3dis.S3DISFusedDataset
#    dataroot: data
#    dataroot: "/mnt/fa444ffd-fdb4-4701-88e7-f00297a8e29b/projects/datasets/s3dis_multimodal"  # DGX DATA
#    dataroot: "/media/drobert-admin/DATA/datasets/s3dis_tp3d_multimodal"  # IGN DATA
    dataroot: "/media/drobert-admin/DATA2/datasets/s3dis_tp3d_multimodal"  # IGN DATA2
    fold: 5
    first_subsampling: 0.05
    use_category: False
    pre_collate_transform:
        - transform: PointCloudFusion    # One point cloud per area
        - transform: SaveOriginalPosId    # Required so that one can recover the original point in the fused point cloud
        - transform: GridSampling3D    # Samples on a grid
          params:
                size: ${data.first_subsampling}
        - transform: SaveOriginalPosId    # Required so that one can recover the multimodal mappings after the transforms
          params:
                key: ${data.multimodal.settings.mapping_key}
    multimodal:    # Each modality must be inserted in a dedicated 'multimodal' section
        modality: image
        settings:
            mapping_key: mapping_index  # hardcoded key used to sync 3D points and modality mappings
            ref_size: [ 256, 128 ]  # [512, 256]
            proj_upscale: 4
            r_max: 8
            r_min: 0.05
            growth_k: 0.5
            growth_r: 100  # growth_k and growth_r set so that correction factor is ~1.1 at r_max=8
            per_sphere_memory_credit: 131072  # 256**128*4 choose based on GPU capacity, model ko/pixel cost and 3D batch_size
        pre_transform:
            - transform: LoadImages    # Read images from disk
              params:
                    ref_size: ${data.multimodal.settings.ref_size}
            - transform: NonStaticMask    # Compute acquisition mask
              params:
                    ref_size: ${data.multimodal.settings.ref_size}
                    proj_upscale: ${data.multimodal.settings.proj_upscale}
                    n_sample: 5
            - transform: MapImages    # Compute the 3D-2D mapping
              params:
                    ref_size: ${data.multimodal.settings.ref_size}
                    proj_upscale: ${data.multimodal.settings.proj_upscale}
                    voxel: ${data.first_subsampling}
                    r_max: ${data.multimodal.settings.r_max}
                    r_min: ${data.multimodal.settings.r_min}
                    growth_k: ${data.multimodal.settings.growth_k}
                    growth_r: ${data.multimodal.settings.growth_r}
        train_transforms:
            - transform: SelectMappingFromPointId  # Select mappings after 3D points sampling
              params:
            - transform: PickImagesFromMappingArea  # Remove images with not enough mappings
              params:
                    area_ratio: 0.02
            - transform: ColorJitter  # Radiometric augmentation
              params:
                    brightness: 0.3
                    contrast: 0.3
                    saturation: 0.6
            - transform: RandomHorizontalFlip
              params:
                    p: 0.5
            - transform: ToFloatImage  # Convert uint8 image to float
            - transform: AddPixelHeightFeature  # Pixel height as image channel
            - transform: CenterRoll  # Roll images to center mappings
              params:
                    angular_res: 16
            - transform: CropImageGroups  # Compute cropping groups to minimize embedding cost
              params:
                    padding: 2
                    min_size: 32
            - transform: PickImagesFromMemoryCredit  # Pick images based on memory credit
              params:
                    credit: ${data.multimodal.settings.per_sphere_memory_credit}
        test_transforms:
            - transform: SelectMappingFromPointId  # Select mappings after 3D points sampling
              params:
            - transform: PickImagesFromMappingArea  # Remove images with not enough mappings
              params:
                    area_ratio: 0.02
            - transform: ToFloatImage  # Convert uint8 image to float
            - transform: AddPixelHeightFeature  # Pixel height as image channel
            - transform: CenterRoll  # Roll images to center mappings
              params:
                    angular_res: 16
            - transform: CropImageGroups  # Compute cropping groups to minimize embedding cost
              params:
                    padding: 2
                    min_size: 32
            - transform: PickImagesFromMemoryCredit  # Pick images based on memory credit
              params:
                    credit: ${data.multimodal.settings.per_sphere_memory_credit}
        val_transforms: ${data.multimodal.test_transforms}
    train_transforms:
        - transform: DropFeature
          params:
                drop_proba: 0.2
                feature_name: rgb
    test_transform:
        - transform: DropFeature
          params:
                drop_proba: 0.2
                feature_name: rgb
    val_transform: ${data.test_transform}
